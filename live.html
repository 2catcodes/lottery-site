<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Draws</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header, footer {
      background-color: #111;
      padding: 10px 0;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    nav a, #connectButton, #refreshBalance {
      color: #0ff;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
    }
    .back-home {
      display: block;
      margin-top: 20px;
      color: #0ff;
      text-decoration: none;
    }
    #walletAddress {
      color: #0f0;
      margin-bottom: 10px;
    }
    #feeBalance {
      margin: 10px 0;
      font-weight: bold;
    }
    .draw-list {
      max-width: 600px;
      margin: 0 auto 30px auto;
      text-align: left;
    }
    .draw-item {
      background: #111;
      margin: 8px 0;
      padding: 12px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .draw-item label {
      cursor: pointer;
      user-select: none;
    }
    footer.ticker {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #111;
      color: #fff;
      padding: 10px;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
    }
    footer.ticker span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 10s linear infinite;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="home">Home</a>
      <a href="buy">Buy $LOTTY</a>
      <a href="live">View Live Draws</a>
      <a href="how">How It Works</a>
      <span id="connectButton">Connect Wallet</span>
      <span id="refreshBalance" title="Refresh Fee Balance" style="margin-left:20px;">üîÑ Refresh Balance</span>
    </nav>
  </header>

  <main>
    <h1>Live Draws</h1>
    <p id="nextDraw">Next draw in: --:--</p>

    <div id="feeBalance">Fee Wallet Balance: Loading...</div>

    <div class="draw-list" id="drawList">
      <!-- Draws will be dynamically inserted here -->
    </div>

    <div>
      <strong>Total Burned Amount: </strong><span id="totalBurned">0</span> SOL
    </div>

    <a class="back-home" href="home">‚Üê Back to Home</a>
    <p id="walletAddress"></p>
  </main>

  <footer class="ticker">
    <span>Contract address coming soon</span>
  </footer>

<script>
  const connectButton = document.getElementById("connectButton");
  const walletAddress = document.getElementById("walletAddress");
  const feeBalanceEl = document.getElementById("feeBalance");
  const refreshBalanceBtn = document.getElementById("refreshBalance");
  const drawListEl = document.getElementById("drawList");
  const totalBurnedEl = document.getElementById("totalBurned");
  const nextDrawEl = document.getElementById("nextDraw");

  // Your dev wallet to authorize burn toggling
  const ownerWallet = "HjMofG9RnWtCDrSP4PDc2xxpBGBtGjZg1KxtTzLSucqu";

  let connectedWallet = null;
  let draws = [];
  let burnedDrawIds = new Set();
  let totalBurned = 0;

  // Example draws every 30 mins starting at 00:00, 00:30, etc.
  function generateDraws() {
    draws = [];
    for(let i = 0; i < 10; i++) {
      const hour = Math.floor(i / 2);
      const minute = (i % 2) * 30;
      const label = `${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}`;
      draws.push({id: i, label, burned: false});
    }
  }

  function renderDraws() {
    drawListEl.innerHTML = "";
    draws.forEach(draw => {
      const div = document.createElement("div");
      div.className = "draw-item";

      const labelSpan = document.createElement("span");
      labelSpan.textContent = `Draw at ${draw.label}`;

      div.appendChild(labelSpan);

      if(connectedWallet === ownerWallet) {
        const label = document.createElement("label");
        label.innerText = "Mark as Burned ";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = draw.burned;
        checkbox.addEventListener("change", (e) => {
          draw.burned = e.target.checked;
          updateBurnTotal();
        });

        label.prepend(checkbox);
        div.appendChild(label);
      }

      drawListEl.appendChild(div);
    });
  }

  function updateBurnTotal() {
    totalBurned = draws.reduce((acc, d) => acc + (d.burned ? 1 : 0), 0) * 1; // Each burned draw adds 1 SOL, update multiplier as needed
    totalBurnedEl.textContent = totalBurned.toFixed(2);
  }

  async function fetchFeeWalletBalance() {
    feeBalanceEl.textContent = "Fee Wallet Balance: Loading...";
    try {
      // Replace with your actual fee wallet address
      const feeWalletAddress = "HjMofG9RnWtCDrSP4PDc2xxpBGBtGjZg1KxtTzLSucqu";

      // Solana JSON RPC call via public endpoint
      const response = await fetch("https://api.mainnet-beta.solana.com", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          jsonrpc: "2.0",
          id: 1,
          method: "getBalance",
          params: [feeWalletAddress]
        })
      });
      const data = await response.json();
      if(data.result) {
        const lamports = data.result.value;
        const sol = lamports / 1e9;
        feeBalanceEl.textContent = `Fee Wallet Balance: ${sol.toFixed(4)} SOL`;
      } else {
        feeBalanceEl.textContent = "Fee Wallet Balance: Error fetching";
      }
    } catch(err) {
      feeBalanceEl.textContent = "Fee Wallet Balance: Error fetching";
      console.error("Fee balance fetch error:", err);
    }
  }

  function updateNextDrawCountdown() {
    const now = new Date();
    // Calculate minutes past the hour and next 30 min mark
    const mins = now.getMinutes();
    const secs = now.getSeconds();
    let nextMinutes = mins < 30 ? 30 : 60;
    let diffMinutes = nextMinutes - mins - 1;
    let diffSeconds = 60 - secs;
    if(diffMinutes < 0) diffMinutes = 0;

    nextDrawEl.textContent = `Next draw in: ${diffMinutes.toString().padStart(2,'0')}:${diffSeconds.toString().padStart(2,'0')}`;
  }

  async function connectWallet() {
    try {
      const resp = await window.solana.connect();
      connectedWallet = resp.publicKey.toString();
      walletAddress.textContent = "Connected: " + connectedWallet.slice(0,4) + "..." + connectedWallet.slice(-4);

      // Re-render draws with or without checkbox depending on wallet
      renderDraws();
    } catch(err) {
      console.error("Wallet connection error:", err);
    }
  }

  connectButton.addEventListener("click", connectWallet);
  refreshBalanceBtn.addEventListener("click", fetchFeeWalletBalance);

  // Init
  generateDraws();
  renderDraws();
  fetchFeeWalletBalance();
  updateNextDrawCountdown();
  setInterval(updateNextDrawCountdown, 1000);
</script>
</body>
</html>
